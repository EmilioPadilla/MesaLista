generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  password      String
  firstName     String
  lastName      String
  spouseFirstName String?
  spouseLastName String?
  slug          String?   @unique
  imageUrl      String?
  phoneNumber   String?
  role          UserRole  @default(GUEST)
  lockedUntil   DateTime? @map("locked_until") // Account lockout timestamp
  failedLoginAttempts Int @default(0) @map("failed_login_attempts")
  lastLoginAt   DateTime? @map("last_login_at") // Last successful login timestamp
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  giftLists     GiftList[]
  sessions      Session[]
  passwordResets PasswordReset[]
  passwordHistory PasswordHistory[]
  loginAttempts LoginAttempt[]
  
  @@map("users")
}

enum UserRole {
  COUPLE
  GUEST
  ADMIN
}

enum PlanType {
  FIXED
  COMMISSION
}

model GiftList {
  id            Int       @id @default(autoincrement())
  userId        Int       @map("user_id")
  title         String
  description   String?
  coupleName    String
  invitationCount Int @default(0)
  eventDate     DateTime  @map("event_date")
  eventLocation String?   @map("event_location")
  eventVenue    String?   @map("event_venue")
  imageUrl      String?   @map("image_url")
  planType      PlanType? @map("plan_type") // Payment plan for this list
  discountCodeId Int?     @map("discount_code_id") // Discount code used for this list
  isActive      Boolean   @default(true) @map("is_active") // Whether this list is currently active
  isPublic      Boolean   @default(true) @map("is_public") // Whether this list appears in search results
  feePreference String    @default("couple") @map("fee_preference") // "couple" or "guest" — who pays payment processing fees
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  discountCode  DiscountCode? @relation(fields: [discountCodeId], references: [id])
  gifts         Gift[]
  categoriesOnGifts GiftCategoryOnGift[]
  invitation    Invitation? // One-to-one relationship with Invitation
  carts         Cart[]    // Carts associated with this gift list
  invitees      Invitee[] // Invitees for this gift list
  rsvpMessages  RsvpMessages? // RSVP messages for this gift list

  @@index([userId])
  @@map("gift_lists")
}

model Gift {
  id            Int       @id @default(autoincrement())
  title         String
  description   String?
  price         Float
  imageUrl      String?
  imagePosition Float?    @default(50) @map("image_position") // Percentage (0-100) for vertical positioning
  isPurchased   Boolean   @default(false)
  isMostWanted    Boolean   @default(false)
  giftListId    Int       @map("gift_list_id")
  quantity      Int       @default(1)
  order         Int       @default(0)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  giftList      GiftList  @relation(fields: [giftListId], references: [id], onDelete: Cascade)
  cartItems     CartItem[]
  categories    GiftCategoryOnGift[]

  @@map("gifts")
}

model GiftCategory {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  gifts     GiftCategoryOnGift[]

  @@map("gift_categories")
}

model GiftCategoryOnGift {
  id             Int          @id @default(autoincrement())
  giftId         Int          @map("gift_id")
  categoryId     Int          @map("category_id")
  giftListId     Int          @map("gift_list_id")
  createdAt      DateTime     @default(now()) @map("created_at")
  gift           Gift         @relation(fields: [giftId], references: [id], onDelete: Cascade)
  category       GiftCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  giftList       GiftList     @relation(fields: [giftListId], references: [id], onDelete: Cascade)

  @@unique([giftId, categoryId])
  @@map("gift_categories_on_gifts")
}

model PredesignedList {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  description String
  imageUrl    String    @map("image_url")
  icon        String    // Icon name from lucide-react
  isActive    Boolean   @default(true) @map("is_active")
  order       Int       @default(0)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  gifts       PredesignedGift[]

  @@map("predesigned_lists")
}

model PredesignedGift {
  id                Int       @id @default(autoincrement())
  title             String
  description       String?
  price             Float
  categories        String[]  // Array of categories
  imageUrl          String    @map("image_url")
  priority          String    @default("media") // 'alta', 'media', 'baja'
  predesignedListId Int       @map("predesigned_list_id")
  order             Int       @default(0)
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  predesignedList   PredesignedList @relation(fields: [predesignedListId], references: [id], onDelete: Cascade)

  @@map("predesigned_gifts")
}

enum PaymentType {
  PAYPAL
  STRIPE
  BANK_TRANSFER
}

enum PaymentStatus {
  PENDING
  REIMBURSED
  PAID
  CANCELLED
}

enum CartStatus {
  PENDING
  PROCESSING
  PAID
  CANCELLED
}

model Cart {
  id            Int            @id @default(autoincrement())
  sessionId     String         @unique @map("session_id")
  giftListId    Int?           @map("gift_list_id") // Gift list this cart belongs to
  inviteeName   String?        @map("invitee_name") // Name of the person shopping
  inviteeEmail  String?        @map("invitee_email") // Email of the person shopping
  country       String?
  phoneNumber   String?        @map("phone_number")
  message       String?        // Message to the couple
  rsvpCode      String?        @map("rsvp_code") // Optional RSVP secret code to link purchase with invitation
  paymentId     String?        @map("payment_id") // External payment ID from PayPal or Stripe
  status        CartStatus     @default(PENDING)
  totalAmount   Float?         @map("total_amount")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  items         CartItem[]
  payment       Payment?       // One-to-one relation
  invitee       Invitee?       @relation(fields: [rsvpCode], references: [secretCode])
  giftList      GiftList?      @relation(fields: [giftListId], references: [id], onDelete: SetNull)

  @@index([rsvpCode])
  @@index([giftListId])
  @@map("carts")
}

model CartItem {
  id            Int            @id @default(autoincrement())
  cartId        Int            @map("cart_id")
  giftId        Int            @map("gift_id")
  quantity      Int            @default(1)
  price         Float          // Store the price at time of adding to cart
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  cart          Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  gift          Gift           @relation(fields: [giftId], references: [id], onDelete: Cascade)

  @@unique([cartId, giftId]) // Prevent duplicate gifts in cart
  @@map("cart_items")
}

model Payment {
  id            Int            @id @default(autoincrement())
  cartId        Int            @unique @map("cart_id")
  paymentId     String         @map("payment_id") // External payment ID from Stripe/PayPal
  currency      String         @default("USD")
  paymentType   PaymentType    @map("payment_type")
  transactionFee Float?        @map("transaction_fee")
  amount        Float          // Total payment amount
  status        PaymentStatus  @default(PENDING)
  metadata      String?
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  cart          Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Session {
  id          String   @id @default(cuid())
  userId      Int      @map("user_id")
  token       String   @unique
  userAgent   String   @map("user_agent")
  ipAddress   String?  @map("ip_address")
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model EmailVerification {
  id          String   @id @default(cuid())
  email       String
  code        String   // 6-digit verification code
  expiresAt   DateTime @map("expires_at")
  verified    Boolean  @default(false)
  attempts    Int      @default(0) // Track failed attempts
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([email, code])
  @@map("email_verifications")
}

model PasswordReset {
  id          String   @id @default(cuid())
  userId      Int      @map("user_id")
  token       String   @unique // Unique hash token for the reset link
  expiresAt   DateTime @map("expires_at")
  used        Boolean  @default(false)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@map("password_resets")
}

model PasswordHistory {
  id          String   @id @default(cuid())
  userId      Int      @map("user_id")
  passwordHash String  @map("password_hash")
  createdAt   DateTime @default(now()) @map("created_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("password_history")
}

model LoginAttempt {
  id          String   @id @default(cuid())
  userId      Int?     @map("user_id") // Nullable to track attempts on non-existent emails
  email       String
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  successful  Boolean  @default(false)
  createdAt   DateTime @default(now()) @map("created_at")

  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email, createdAt])
  @@index([userId, createdAt])
  @@map("login_attempts")
}

model DiscountCode {
  id              Int      @id @default(autoincrement())
  code            String   @unique // The discount code string (e.g., "SUMMER2024")
  discountType    DiscountType @map("discount_type") // PERCENTAGE or FIXED_AMOUNT
  discountValue   Float    @map("discount_value") // Percentage (0-100) or fixed amount
  usageLimit      Int      @map("usage_limit") // Maximum number of times this code can be used
  usageCount      Int      @default(0) @map("usage_count") // Current usage count
  isActive        Boolean  @default(true) @map("is_active") // Can be deactivated without deletion
  expiresAt       DateTime? @map("expires_at") // Optional expiration date
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  giftLists       GiftList[] // Gift lists that used this discount code

  @@index([code])
  @@map("discount_codes")
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

// Analytics Models

// Session tracking for UTM parameters and referrer
model AnalyticsSession {
  id            String   @id @default(uuid())
  sessionId     String   @unique @map("session_id") // Browser session/fingerprint ID
  userHash      String?  @map("user_hash") // SHA256 hash of user_id for privacy
  utmSource     String?  @map("utm_source")
  utmMedium     String?  @map("utm_medium")
  utmCampaign   String?  @map("utm_campaign")
  utmTerm       String?  @map("utm_term")
  utmContent    String?  @map("utm_content")
  referrer      String?  // Full referrer URL
  landingPage   String?  @map("landing_page") // First page visited
  ipAddress     String?  @map("ip_address")
  userAgent     String?  @map("user_agent")
  startedAt     DateTime @default(now()) @map("started_at")
  endedAt       DateTime? @map("ended_at")
  pageViews     Int      @default(0) @map("page_views") // Count of page views in session
  durationMs    Int?     @map("duration_ms") // Session duration in milliseconds
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([sessionId])
  @@index([utmSource, startedAt])
  @@index([landingPage, startedAt])
  @@index([startedAt])
  @@map("analytics_sessions")
}

model AnalyticsEvent {
  id          String   @id @default(uuid())
  userHash    String?  @map("user_hash") // SHA256 hash of user_id for privacy
  sessionId   String   @map("session_id") // Browser session/fingerprint ID
  eventType   AnalyticsEventType @map("event_type")
  metadata    Json?    // Optional additional data (e.g., registry_id, gift_id, path, utm_*, etc.)
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([eventType, createdAt])
  @@index([sessionId, createdAt])
  @@index([userHash, createdAt])
  @@map("analytics_events")
}

enum AnalyticsEventType {
  PAGE_VIEW
  SIGN_IN
  REGISTRY_ATTEMPT
  REGISTRY_PURCHASE
  GIFT_PURCHASE
  VIEW_PRICING
  VIEW_REGISTRY_BUILDER
  START_CHECKOUT
  CHECKOUT_ERROR
  SESSION_START
  SESSION_END
}

model AnalyticsDaily {
  id                    Int      @id @default(autoincrement())
  date                  DateTime @unique @db.Date
  visitors              Int      @default(0) // Unique sessions with PAGE_VIEW
  signIns               Int      @default(0) @map("sign_ins") // Unique users with SIGN_IN
  registryPurchases     Int      @default(0) @map("registry_purchases") // REGISTRY_PURCHASE events
  giftPurchases         Int      @default(0) @map("gift_purchases") // GIFT_PURCHASE events
  viewPricing           Int      @default(0) @map("view_pricing") // VIEW_PRICING events
  viewRegistryBuilder   Int      @default(0) @map("view_registry_builder") // VIEW_REGISTRY_BUILDER events
  startCheckouts        Int      @default(0) @map("start_checkouts") // START_CHECKOUT events
  checkoutErrors        Int      @default(0) @map("checkout_errors") // CHECKOUT_ERROR events
  checkoutAbandonments  Int      @default(0) @map("checkout_abandonments") // Calculated: start_checkouts - purchases
  avgPagesPerSession    Float?   @default(0) @map("avg_pages_per_session")
  avgSessionDurationMs  Float?   @default(0) @map("avg_session_duration_ms")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@index([date])
  @@map("analytics_daily")
}

// Hourly aggregates for near-real-time metrics (last 48 hours)
model AnalyticsHourly {
  id                    Int      @id @default(autoincrement())
  hour                  DateTime @unique @db.Timestamptz // Hour timestamp
  visitors              Int      @default(0)
  signIns               Int      @default(0) @map("sign_ins")
  registryPurchases     Int      @default(0) @map("registry_purchases")
  giftPurchases         Int      @default(0) @map("gift_purchases")
  viewPricing           Int      @default(0) @map("view_pricing")
  viewRegistryBuilder   Int      @default(0) @map("view_registry_builder")
  startCheckouts        Int      @default(0) @map("start_checkouts")
  checkoutErrors        Int      @default(0) @map("checkout_errors")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@index([hour])
  @@map("analytics_hourly")
}

// RSVP Models

model Invitee {
  id                String        @id @default(cuid())
  giftListId        Int           @map("gift_list_id")
  firstName         String        @map("first_name")
  lastName          String        @map("last_name")
  tickets           Int           @default(1) // Maximum number of people allowed
  secretCode        String        @unique @map("secret_code") // Unique code for confirmation
  status            RsvpStatus    @default(PENDING)
  confirmedTickets  Int?          @map("confirmed_tickets") // Actual number confirming
  guestMessage      String?       @map("guest_message") @db.Text // Optional message from guest
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  respondedAt       DateTime?     @map("responded_at") // When they responded
  carts             Cart[]        // Purchases made by this invitee
  giftList          GiftList      @relation(fields: [giftListId], references: [id], onDelete: Cascade)

  @@index([giftListId])
  @@index([secretCode])
  @@index([status])
  @@map("invitees")
}

enum RsvpStatus {
  PENDING
  CONFIRMED
  REJECTED
}

model RsvpMessages {
  id                    Int      @id @default(autoincrement())
  giftListId            Int      @unique @map("gift_list_id")
  giftList              GiftList @relation(fields: [giftListId], references: [id], onDelete: Cascade)
  confirmationMessage   String   @default("¡Gracias por confirmar tu asistencia! Nos encantará verte en nuestra boda.") @map("confirmation_message")
  cancellationMessage   String   @default("Lamentamos que no puedas asistir. ¡Gracias por avisarnos!") @map("cancellation_message")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@index([giftListId])
  @@map("rsvp_messages")
}

// Email Analytics Models
model EmailAnalytics {
  id              String            @id @default(uuid())
  messageId       String            @unique @map("message_id") // Postmark MessageID
  recipient       String            // Email recipient
  subject         String?           // Email subject
  eventType       EmailEventType    @map("event_type")
  tag             String?           // Email tag (e.g., "payment_confirmation", "verification")
  metadata        Json?             // Additional event data from Postmark
  recordedAt      DateTime          @map("recorded_at") // When the event occurred
  createdAt       DateTime          @default(now()) @map("created_at")

  @@index([eventType, recordedAt])
  @@index([recipient, recordedAt])
  @@index([tag, recordedAt])
  @@index([recordedAt])
  @@map("email_analytics")
}

enum EmailEventType {
  DELIVERY        // Email successfully delivered
  BOUNCE          // Email bounced (hard or soft)
  SPAM_COMPLAINT  // Recipient marked as spam
  OPEN            // Email opened (first open only)
  LINK_CLICK      // Link clicked in email
}

// Daily email analytics aggregates
model EmailAnalyticsDaily {
  id                Int      @id @default(autoincrement())
  date              DateTime @unique @db.Date
  sent              Int      @default(0) // Total emails sent (calculated from deliveries + bounces)
  delivered         Int      @default(0) // Successfully delivered
  bounced           Int      @default(0) // Bounced emails
  opened            Int      @default(0) // Unique opens
  clicked           Int      @default(0) // Unique clicks
  spamComplaints    Int      @default(0) @map("spam_complaints")
  deliveryRate      Float    @default(0) @map("delivery_rate") // delivered / sent * 100
  openRate          Float    @default(0) @map("open_rate") // opened / delivered * 100
  clickRate         Float    @default(0) @map("click_rate") // clicked / delivered * 100
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@index([date])
  @@map("email_analytics_daily")
}

// Invitation model for digital invitations linked to gift lists
model Invitation {
  id            Int       @id @default(autoincrement())
  giftListId    Int       @unique @map("gift_list_id") // One-to-one relationship
  templateId    String    @map("template_id") // Template identifier (e.g., "elegant-wedding")
  eventName     String    @map("event_name") // Name of the event
  htmlContent   String    @db.Text @map("html_content") // Rendered HTML template
  formData      Json      @map("form_data") // JSON object with all form field values
  customColors  Json?     @map("custom_colors") // Optional custom color scheme
  status        InvitationStatus @default(DRAFT) // Publication status
  publishedAt   DateTime? @map("published_at") // When the invitation was published
  viewCount     Int       @default(0) @map("view_count") // Number of times viewed
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  giftList      GiftList  @relation(fields: [giftListId], references: [id], onDelete: Cascade)

  @@index([giftListId])
  @@index([status])
  @@map("invitations")
}

enum InvitationStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// Marketing: Collected emails from signup attempts and manual additions
model SignupEmail {
  id          Int      @id @default(autoincrement())
  email       String   @unique
  source      String   @default("signup") // "signup" or "manual"
  firstName   String?  @map("first_name")
  lastName    String?  @map("last_name")
  phone       String?
  convertedToUser Boolean @default(false) @map("converted_to_user")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([email])
  @@index([source])
  @@map("signup_emails")
}
